<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…§éƒ¨æª”æ¡ˆä¸‹è¼‰ä¸­å¿ƒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 80px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .file-card { transition: transform 0.2s; }
        .file-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        /* ä¸‹è¼‰é€£çµçš„æ¨£å¼ */
        .download-link { font-weight: bold; text-decoration: none; color: #0d6efd; }
        .download-link:hover { text-decoration: underline; color: #0a58ca; }
    </style>
</head>
<body class="bg-light">

    <div id="loginSection" class="container">
        <div class="login-container text-center">
            <h3>ğŸ“‚ æª”æ¡ˆä¸­å¿ƒç™»å…¥</h3>
            <p class="text-muted">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä»¥å­˜å–è³‡æº</p>
            <div class="mb-3 mt-4"><input type="email" id="loginEmail" class="form-control" placeholder="é›»å­ä¿¡ç®±"></div>
            <div class="mb-3"><input type="password" id="loginPwd" class="form-control" placeholder="å¯†ç¢¼"></div>
            <button id="btnLogin" class="btn btn-primary w-100">ç™»å…¥</button>
            <p id="loginError" class="text-danger mt-2"></p>
        </div>
    </div>

    <div id="mainSection" class="container hidden p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>ğŸ“‚ å…¬å¸è³‡æºä¸‹è¼‰å€ <span id="roleBadge" class="badge bg-secondary">è¼‰å…¥ä¸­...</span></h4>
            <button id="btnLogout" class="btn btn-outline-danger btn-sm">ç™»å‡º</button>
        </div>

        <div id="adminPanel" class="card p-4 mb-4 border-primary hidden" style="border-width: 2px;">
            <h5 class="text-primary">ğŸ“¤ æ–°å¢æª”æ¡ˆè³‡æº (ç®¡ç†å“¡å°ˆç”¨)</h5>
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" id="fileName" class="form-control" placeholder="æª”æ¡ˆé¡¯ç¤ºåç¨± (ä¾‹ï¼š12æœˆæœƒè­°è¨˜éŒ„)">
                </div>
                <div class="col-md-6">
                    <input type="text" id="fileUrl" class="form-control" placeholder="è«‹è²¼ä¸Š Google Drive å…±ç”¨é€£çµ">
                </div>
                <div class="col-md-2">
                    <button id="btnAddFile" class="btn btn-primary w-100">ç™¼å¸ƒæª”æ¡ˆ</button>
                </div>
            </div>
            <div class="form-text mt-2">ğŸ’¡ ç³»çµ±æœƒè‡ªå‹•å°‡ Google Drive é€£çµè½‰æ›ç‚ºã€Œç›´æ¥ä¸‹è¼‰ã€æ¨¡å¼ã€‚</div>
        </div>

        <div class="card p-3">
            <h5 class="mb-3">ğŸ“¥ å¯ä¸‹è¼‰æª”æ¡ˆåˆ—è¡¨</h5>
            <div id="fileList" class="list-group list-group-flush">
                <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„ Firebase Config âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
            apiKey: "AIzaSyBbS-qgY5AvBnRcK3R4CRiOCQTma8DOBUg",
            authDomain: "menu-db-b25a3.firebaseapp.com",
            projectId: "menu-db-b25a3",
            storageBucket: "menu-db-b25a3.firebasestorage.app",
            messagingSenderId: "575823211478",
            appId: "1:575823211478:web:950ced76ff34f586d0d277"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ğŸ”¥ ç¢ºèªé€™è£¡æ˜¯è€é—† Email
        const ADMIN_EMAIL = "admin@ggwp.com"; 

        // --- ç™»å…¥ç‹€æ…‹ç›£è½ ---
        onAuthStateChanged(auth, (user) => {
            const loginDiv = document.getElementById('loginSection');
            const mainDiv = document.getElementById('mainSection');
            const adminPanel = document.getElementById('adminPanel');

            if (user) {
                loginDiv.classList.add('hidden');
                mainDiv.classList.remove('hidden');

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('roleBadge').innerText = "ç®¡ç†å“¡";
                    document.getElementById('roleBadge').className = "badge bg-danger";
                    adminPanel.classList.remove('hidden'); 
                } else {
                    document.getElementById('roleBadge').innerText = "ä¸€èˆ¬æˆå“¡";
                    document.getElementById('roleBadge').className = "badge bg-success";
                    adminPanel.classList.add('hidden');    
                }
                loadFiles(user.email === ADMIN_EMAIL);
            } else {
                loginDiv.classList.remove('hidden');
                mainDiv.classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPwd').value)
                .catch(e => document.getElementById('loginError').innerText = "ç™»å…¥å¤±æ•—ï¼š" + e.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        // --- ä¸Šå‚³æª”æ¡ˆ ---
        document.getElementById('btnAddFile').addEventListener('click', async () => {
            const name = document.getElementById('fileName').value;
            const url = document.getElementById('fileUrl').value;

            if(!name || !url) { alert("è«‹è¼¸å…¥åç¨±å’Œé€£çµ"); return; }

            try {
                await addDoc(collection(db, "files"), {
                    name: name,
                    url: url,
                    uploader: ADMIN_EMAIL,
                    createdAt: serverTimestamp()
                });
                alert("âœ… æª”æ¡ˆç™¼å¸ƒæˆåŠŸï¼");
                document.getElementById('fileName').value = '';
                document.getElementById('fileUrl').value = '';
            } catch (e) {
                alert("âŒ ç™¼å¸ƒå¤±æ•—ï¼š" + e.message);
            }
        });

        // (åŸæœ¬çš„è½‰æ›å‡½å¼æˆ‘åˆªæ‰äº†ï¼Œè®“å®ƒç›´æ¥ç”¨åŸå§‹é€£çµ)

        // --- è®€å–æª”æ¡ˆåˆ—è¡¨ ---
        function loadFiles(isAdmin) {
            const q = query(collection(db, "files"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('fileList');
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æª”æ¡ˆ</div>';
                    return;
                }

                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    
                    // åˆ¤æ–·åœ–ç¤º
                    let icon = "ğŸ“„"; 
                    if(data.url.includes("drive.google.com")) icon = "â˜ï¸";

                    // åˆªé™¤æŒ‰éˆ•
                    const deleteBtn = isAdmin ? 
                        `<button class="btn btn-outline-danger btn-sm ms-3 del-btn" data-id="${docSnapshot.id}">åˆªé™¤</button>` : '';

                    // æ™‚é–“
                    let dateStr = "";
                    if(data.createdAt) {
                        const date = data.createdAt.toDate();
                        dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${(date.getMinutes()<10?'0':'')+date.getMinutes()}`;
                    }

                    const item = document.createElement('div');
                    item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3";
                    
                    // âš ï¸ ä¿®æ”¹é‡é»ï¼š
                    // 1. href æ”¹å›ç›´æ¥ç”¨ data.url (åŸå§‹é€£çµ)
                    // 2. åŠ ä¸Š target="_blank" (å¼·åˆ¶é–‹æ–°åˆ†é ï¼Œé¿å…è“‹æ‰åŸæœ¬ç¶²ç«™)
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="fs-4 me-3">${icon}</div>
                            <div>
                                <a href="${data.url}" target="_blank" class="download-link stretched-link" style="position: relative; z-index: 1;">
                                    ${data.name}
                                </a>
                                <div class="text-muted small">ä¸Šå‚³æ™‚é–“: ${dateStr}</div>
                            </div>
                        </div>
                        <div style="position: relative; z-index: 2;">
                            ${deleteBtn}
                        </div>
                    `;
                    list.appendChild(item);
                });

                if (isAdmin) {
                    document.querySelectorAll('.del-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation(); 
                            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æª”æ¡ˆé€£çµå—ï¼Ÿ")) {
                                await deleteDoc(doc(db, "files", btn.dataset.id));
                            }
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>