<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œé‚Šé»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        .menu-item { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #e9ecef; }
        .price-tag { color: #0d6efd; font-weight: bold; font-size: 1.1rem; }
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px; border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center;
        }
        .section-title { font-weight: bold; margin: 20px 0 10px 0; display: flex; align-items: center; }
        .icon { margin-right: 5px; }
    </style>
</head>
<body>

<div class="container mt-3">
    <h3>ğŸ“± æ¡Œé‚Šé»é¤ (æ¡Œè™Ÿ: T00)</h3>

    <div class="section-title">ğŸ² èœå–® Menu</div>
    <div id="menu-container">
        </div>

    <div class="section-title">ğŸ›’ æ‚¨çš„è¨‚å–®</div>
    <div class="card p-3 mb-3 bg-light text-center text-muted" id="empty-cart-msg">
        ç›®å‰æ²’æœ‰é»é¸ä»»ä½•é¤é»ã€‚
    </div>
    <ul class="list-group mb-3" id="cart-list" style="display:none;">
        </ul>
</div>

<div class="sticky-footer">
    <button class="btn btn-success w-100 btn-lg" onclick="submitOrder()">
        âœ… ç¢ºèªé€å‡ºè¨‚å–® (<span id="total-price">0</span> å…ƒ)
    </button>
</div>




<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    // æ³¨æ„ï¼šé€™è£¡å¤šå¼•å…¥äº† addDoc å’Œ serverTimestamp
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„é‘°åŒ™ âš ï¸âš ï¸âš ï¸
    const firebaseConfig = {
        apiKey: "AIzaSyBbS-qgY5AvBnRcK3R4CRiOCQTma8DOBUg",
        authDomain: "menu-db-b25a3.firebaseapp.com",
        projectId: "menu-db-b25a3",
        storageBucket: "menu-db-b25a3.firebasestorage.app",
        messagingSenderId: "575823211478",
        appId: "1:575823211478:web:950ced76ff34f586d0d277"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let cart = {}; 
    let menuData = [];

    // 1. è®€å–èœå–® (ç¶­æŒä¸è®Š)
    async function loadMenu() {
        const querySnapshot = await getDocs(collection(db, "menu"));
        menuData = [];
        querySnapshot.forEach((doc) => {
            menuData.push({ id: doc.id, ...doc.data() });
        });
        renderMenu();
    }

    function renderMenu() {
        const container = document.getElementById('menu-container');
        let html = '';
        menuData.forEach(item => {
            html += `
            <div class="menu-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="m-0">${item.name}</h5>
                    <span class="price-tag">NT$${item.price}</span>
                </div>
                <div class="row align-items-center mb-2">
                    <div class="col-auto">æ•¸é‡:</div>
                    <div class="col">
                        <input type="number" class="form-control" min="0" value="0" 
                            onchange="window.updateCart('${item.id}', this.value)">
                    </div>
                </div>
                <input type="text" class="form-control form-control-sm" 
                    placeholder="${item.placeholder || 'å‚™è¨»...'}" 
                    oninput="window.updateNote('${item.id}', this.value)">
            </div>`;
        });
        container.innerHTML = html;
    }

    // 2. è³¼ç‰©è»Šé‚è¼¯ (ç¶­æŒä¸è®Š)
    window.updateCart = function(id, qty) {
        qty = parseInt(qty);
        if (qty > 0) {
            if (!cart[id]) {
                const product = menuData.find(p => p.id === id);
                cart[id] = { ...product, qty: qty, note: "" };
            } else {
                cart[id].qty = qty;
            }
        } else {
            delete cart[id];
        }
        renderCartSummary();
    }

    window.updateNote = function(id, text) {
        if (cart[id]) cart[id].note = text;
    }

    function renderCartSummary() {
        const list = document.getElementById('cart-list');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const totalSpan = document.getElementById('total-price');
        list.innerHTML = '';
        let total = 0;
        let hasItems = false;
        for (let key in cart) {
            hasItems = true;
            const item = cart[key];
            total += item.price * item.qty;
            list.innerHTML += `<li class="list-group-item">
                ${item.name} x ${item.qty} <small class="text-muted">(${item.note})</small>
                <span class="float-end">$${item.price * item.qty}</span>
            </li>`;
        }
        totalSpan.innerText = total;
        if (hasItems) { emptyMsg.style.display = 'none'; list.style.display = 'block'; }
        else { emptyMsg.style.display = 'block'; list.style.display = 'none'; }
    }

    // 3. ã€æ–°åŠŸèƒ½ã€‘é€å‡ºè¨‚å–®
    window.submitOrder = async function() {
        if (Object.keys(cart).length === 0) {
            alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼");
            return;
        }
        
        // å–å¾—æ¡Œè™Ÿ (é€™è£¡å…ˆå¯«æ­» T01ï¼Œä¹‹å¾Œå¯ä»¥å¾ç¶²å€æŠ“)
        const tableId = "T01"; 
        
        // è¨ˆç®—ç¸½é‡‘é¡
        let total = 0;
        for(let key in cart) total += cart[key].price * cart[key].qty;

        try {
            // å¯«å…¥è³‡æ–™åº«
            await addDoc(collection(db, "orders"), {
                table: tableId,
                items: cart,     // è³¼ç‰©è»Šå…§å®¹
                total: total,    // ç¸½é‡‘é¡
                status: "pending", // ç‹€æ…‹ï¼šå¾…è™•ç†
                createdAt: serverTimestamp() // è¨‚å–®æ™‚é–“
            });

            alert("âœ… è¨‚å–®å·²å‚³é€çµ¦å»šæˆ¿ï¼");
            cart = {}; // æ¸…ç©ºè³¼ç‰©è»Š
            renderCartSummary(); // é‡ç¹ªç•«é¢
            // æ‰€æœ‰è¼¸å…¥æ¡†æ­¸é›¶ (ç°¡å–®æš´åŠ›æ³•ï¼šé‡æ–°æ•´ç†é é¢ï¼Œæˆ–è€…æ‰‹å‹•æ¸…ç©º)
            location.reload(); 

        } catch (error) {
            console.error("è¨‚å–®å‚³é€å¤±æ•—:", error);
            alert("âŒ å‚³é€å¤±æ•—ï¼Œè«‹æ‰¾æœå‹™äººå“¡");
        }
    }

    loadMenu();
</script>








</body>
</html>