<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œé‚Šé»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        .menu-item { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #e9ecef; }
        .price-tag { color: #0d6efd; font-weight: bold; font-size: 1.1rem; }
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px; border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center;
        }
        
        /* æ­¡è¿ç•«é¢æ¨£å¼ */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
        }
        .welcome-card {
            width: 100%; max-width: 350px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="welcome-card">
            <h2 class="mb-4">ğŸ½ï¸ æ­¡è¿å…‰è‡¨</h2>
            <p class="text-muted">è«‹è¼¸å…¥æ‚¨ç›®å‰çš„æ¡Œè™Ÿä»¥é–‹å§‹é»é¤</p>
            
            <div class="mb-3">
                <input type="text" id="tableInput" class="form-control form-control-lg text-center" placeholder="ä¾‹å¦‚ï¼š1 æˆ– A2">
            </div>
            
            <button class="btn btn-primary btn-lg w-100" onclick="startOrdering()">é–‹å§‹é»é¤</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container mt-3">
            <h3>ğŸ“± æ¡Œé‚Šé»é¤ (æ¡Œè™Ÿ: <span id="table-num">...</span>)</h3>

            <div class="mt-4 mb-2 fw-bold">ğŸ² èœå–® Menu</div>
            <div id="menu-container">
                </div>

            <div class="mt-4 mb-2 fw-bold">ğŸ›’ æ‚¨çš„è¨‚å–®</div>
            <div class="card p-3 mb-3 bg-light text-center text-muted" id="empty-cart-msg">
                ç›®å‰æ²’æœ‰é»é¸ä»»ä½•é¤é»ã€‚
            </div>
            <ul class="list-group mb-3" id="cart-list" style="display:none;"></ul>
        </div>

        <div class="sticky-footer">
            <button class="btn btn-success w-100 btn-lg" onclick="window.submitOrder()">
                âœ… ç¢ºèªé€å‡ºè¨‚å–® (<span id="total-price">0</span> å…ƒ)
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„é‘°åŒ™ âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
            apiKey: "AIzaSyBbS-qgY5AvBnRcK3R4CRiOCQTma8DOBUg",
            authDomain: "menu-db-b25a3.firebaseapp.com",
            projectId: "menu-db-b25a3",
            storageBucket: "menu-db-b25a3.firebasestorage.app",
            messagingSenderId: "575823211478",
            appId: "1:575823211478:web:950ced76ff34f586d0d277"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let cart = {}; 
        let menuData = [];
        let currentTable = ""; // å„²å­˜ç›®å‰çš„æ¡Œè™Ÿ

        // --- æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·æ˜¯å¦éœ€è¦è¼¸å…¥æ¡Œè™Ÿ ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlTable = urlParams.get('table');

            if (urlTable) {
                // ç‹€æ³ Aï¼šç¶²å€å·²ç¶“æœ‰æ¡Œè™Ÿ (ä¾‹å¦‚ ?table=5) -> ç›´æ¥é€²èœå–®
                enterApp(urlTable);
            } else {
                // ç‹€æ³ Bï¼šç¶²å€æ²’æ¡Œè™Ÿ -> åœç•™åœ¨æ­¡è¿ç•«é¢ï¼Œç­‰å¾…è¼¸å…¥
                // (ä¸éœ€è¦åšä»»ä½•äº‹ï¼Œå› ç‚º HTML é è¨­å°±æ˜¯é¡¯ç¤ºæ­¡è¿ç•«é¢)
            }
        }

        // ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œé–‹å§‹é»é¤ã€
        window.startOrdering = function() {
            const input = document.getElementById('tableInput').value.trim();
            if (!input) {
                alert("è«‹è¼¸å…¥æ¡Œè™Ÿæ‰èƒ½é»é¤å–”ï¼");
                return;
            }
            // ä½¿ç”¨ pushState ä¿®æ”¹ç¶²å€ä½†ä¸é‡æ–°æ•´ç† (è®Šæˆ ?table=è¼¸å…¥çš„å€¼)
            // é€™æ¨£å®¢äººå¦‚æœé‡æ–°æ•´ç†ç¶²é ï¼Œæ‰ä¸æœƒåˆè·³å›è¼¸å…¥ç•«é¢
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?table=' + input;
            window.history.pushState({path: newUrl}, '', newUrl);

            enterApp(input);
        }

        // é€²å…¥ä¸»ç¨‹å¼
        function enterApp(tableId) {
            currentTable = tableId;
            document.getElementById('table-num').innerText = tableId;
            
            // åˆ‡æ›ç•«é¢ï¼šéš±è—æ­¡è¿é ï¼Œé¡¯ç¤ºä¸»ç¨‹å¼
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            loadMenu(); // è¼‰å…¥èœå–®
        }

        // --- ä»¥ä¸‹æ˜¯åŸæœ¬çš„é»é¤é‚è¼¯ (ç¶­æŒä¸è®Š) ---

        async function loadMenu() {
            const querySnapshot = await getDocs(collection(db, "menu"));
            menuData = [];
            querySnapshot.forEach((doc) => {
                menuData.push({ id: doc.id, ...doc.data() });
            });
            renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            let html = '';
            menuData.forEach(item => {
                html += `
                <div class="menu-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">${item.name}</h5>
                        <span class="price-tag">NT$${item.price}</span>
                    </div>
                    <div class="row align-items-center mb-2">
                        <div class="col-auto">æ•¸é‡:</div>
                        <div class="col">
                            <input type="number" class="form-control" min="0" value="0" 
                                onchange="window.updateCart('${item.id}', this.value)">
                        </div>
                    </div>
                    <input type="text" class="form-control form-control-sm" 
                        placeholder="${item.placeholder || 'å‚™è¨»...'}" 
                        oninput="window.updateNote('${item.id}', this.value)">
                </div>`;
            });
            container.innerHTML = html;
        }

        window.updateCart = function(id, qty) {
            qty = parseInt(qty);
            if (qty > 0) {
                if (!cart[id]) {
                    const product = menuData.find(p => p.id === id);
                    cart[id] = { ...product, qty: qty, note: "" };
                } else {
                    cart[id].qty = qty;
                }
            } else {
                delete cart[id];
            }
            renderCartSummary();
        }

        window.updateNote = function(id, text) {
            if (cart[id]) cart[id].note = text;
        }

        function renderCartSummary() {
            const list = document.getElementById('cart-list');
            const emptyMsg = document.getElementById('empty-cart-msg');
            const totalSpan = document.getElementById('total-price');
            list.innerHTML = '';
            let total = 0;
            let hasItems = false;
            for (let key in cart) {
                hasItems = true;
                const item = cart[key];
                total += item.price * item.qty;
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
                    <div>${item.name} x ${item.qty} <small class="text-muted">${item.note}</small></div>
                    <span>$${item.price * item.qty}</span>
                </li>`;
            }
            totalSpan.innerText = total;
            if (hasItems) { emptyMsg.style.display = 'none'; list.style.display = 'block'; }
            else { emptyMsg.style.display = 'block'; list.style.display = 'none'; }
        }

        window.submitOrder = async function() {
            if (Object.keys(cart).length === 0) {
                alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼");
                return;
            }
            
            // ä½¿ç”¨æˆ‘å€‘è¼¸å…¥çš„æ¡Œè™Ÿ
            const tableId = currentTable; 
            
            let total = 0;
            for(let key in cart) total += cart[key].price * cart[key].qty;

            try {
                await addDoc(collection(db, "orders"), {
                    table: tableId,
                    items: cart,
                    total: total,
                    status: "pending",
                    createdAt: serverTimestamp()
                });

                alert("âœ… è¨‚å–®å·²é€å‡ºï¼");
                location.reload(); // é€å‡ºå¾Œé‡æ–°æ•´ç† (æœƒè®Šå›æœ‰æ¡Œè™Ÿçš„ç‹€æ…‹ï¼Œæ–¹ä¾¿çºŒé»)
            } catch (error) {
                console.error("Error:", error);
                alert("âŒ å‚³é€å¤±æ•—");
            }
        }
    </script>
</body>
</html>