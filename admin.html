<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ç®¡ç†ç³»çµ± - ç™»å…¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-card { border-left: 5px solid #0d6efd; background: #fff; margin-bottom: 15px; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">

    <div id="loginSection" class="container">
        <div class="login-container text-center">
            <h3>ğŸ” å“¡å·¥ç™»å…¥</h3>
            <div class="mb-3 mt-4">
                <input type="email" id="loginEmail" class="form-control" placeholder="é›»å­ä¿¡ç®±">
            </div>
            <div class="mb-3">
                <input type="password" id="loginPwd" class="form-control" placeholder="å¯†ç¢¼">
            </div>
            <button id="btnLogin" class="btn btn-primary w-100">ç™»å…¥ç³»çµ±</button>
            <p id="loginError" class="text-danger mt-2"></p>
        </div>
    </div>

    <div id="dashboardSection" class="container hidden p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>ğŸ‘¨â€ğŸ³ é¤å»³ç®¡ç†ç³»çµ± <span id="userRoleBadge" class="badge bg-secondary">å“¡å·¥</span></h4>
            <button id="btnLogout" class="btn btn-outline-danger btn-sm">ç™»å‡º : <span id="currentUserEmail"></span></button>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-orders-tab" data-bs-toggle="pill" data-bs-target="#pills-orders" type="button">ğŸ”” æ¥æ”¶è¨‚å–®</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-menu-tab" data-bs-toggle="pill" data-bs-target="#pills-menu" type="button">ğŸ“ èœå–®ç®¡ç†</button>
            </li>
            <li class="nav-item hidden" id="admin-tab-li" role="presentation">
                <button class="nav-link" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users" type="button">ğŸ‘¥ å“¡å·¥ç®¡ç†</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-orders">
                <div id="orderList"><p class="text-center text-muted">ç­‰å¾…æ–°è¨‚å–®ä¸­...</p></div>
            </div>

            <div class="tab-pane fade" id="pills-menu">
                <div id="menuControlPanel" class="card p-3 mb-3">
                    <div class="input-group mb-2">
                        <input type="text" id="name" class="form-control" placeholder="èœå">
                        <input type="number" id="price" class="form-control" placeholder="åƒ¹æ ¼">
                    </div>
                    <input type="text" id="note" class="form-control mb-2" placeholder="å‚™è¨»æç¤º">
                    <button id="addBtn" class="btn btn-primary w-100">æ–°å¢èœå–®</button>
                </div>
                <div id="menuControlLock" class="alert alert-warning hidden">âš ï¸ åªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹èœå–®</div>
                <ul id="menuList" class="list-group"></ul>
            </div>

            <div class="tab-pane fade" id="pills-users">
                <div class="card p-3">
                    <h5>æ–°å¢å“¡å·¥å¸³è™Ÿ</h5>
                    <div class="mb-2">
                        <input type="email" id="newStaffEmail" class="form-control mb-2" placeholder="æ–°å“¡å·¥ Email">
                        <input type="password" id="newStaffPwd" class="form-control mb-2" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)">
                    </div>
                    <button id="btnCreateUser" class="btn btn-success w-100">å»ºç«‹å¸³è™Ÿ</button>
                    <p class="text-muted small mt-2">* èªªæ˜ï¼šåŸºæ–¼å®‰å…¨é™åˆ¶ï¼Œç›®å‰åªèƒ½æ–°å¢ï¼Œè‹¥éœ€åˆªé™¤è«‹è‡³ Firebase Console æ“ä½œã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // å¼•å…¥ Authentication åŠŸèƒ½
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„é‘°åŒ™ âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
            apiKey: "AIzaSyBbS-qgY5AvBnRcK3R4CRiOCQTma8DOBUg",
            authDomain: "menu-db-b25a3.firebaseapp.com",
            projectId: "menu-db-b25a3",
            storageBucket: "menu-db-b25a3.firebasestorage.app",
            messagingSenderId: "575823211478",
            appId: "1:575823211478:web:950ced76ff34f586d0d277"
        };

        // 1. åˆå§‹åŒ–ä¸»ç¨‹å¼
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ğŸ”¥ è¨­å®šï¼šè«‹åœ¨é€™è£¡è¼¸å…¥ã€Œè€é—†ã€çš„ Email (å¿…é ˆè·Ÿä½ åœ¨ Firebase Console å»ºç«‹çš„ä¸€æ¨¡ä¸€æ¨£)
        const ADMIN_EMAIL = "admin@ggwp.com"; 

        // 2. ç›£è½ç™»å…¥ç‹€æ…‹ (é€™æ˜¯é–€ç¥)
        onAuthStateChanged(auth, (user) => {
            const loginDiv = document.getElementById('loginSection');
            const dashboardDiv = document.getElementById('dashboardSection');
            const menuPanel = document.getElementById('menuControlPanel');
            const menuLock = document.getElementById('menuControlLock');
            const adminTab = document.getElementById('admin-tab-li');

            if (user) {
                // --- å·²ç™»å…¥ ---
                loginDiv.classList.add('hidden');
                dashboardDiv.classList.remove('hidden');
                document.getElementById('currentUserEmail').innerText = user.email;

                // æª¢æŸ¥æ˜¯å¦ç‚ºè€é—†
                if (user.email === ADMIN_EMAIL) {
                    // æ˜¯è€é—†ï¼šé¡¯ç¤ºæ‰€æœ‰åŠŸèƒ½
                    document.getElementById('userRoleBadge').innerText = "è¶…ç´šç®¡ç†å“¡";
                    document.getElementById('userRoleBadge').className = "badge bg-danger";
                    menuPanel.classList.remove('hidden');
                    menuLock.classList.add('hidden');
                    adminTab.classList.remove('hidden'); // é¡¯ç¤ºå“¡å·¥ç®¡ç†åˆ†é 
                } else {
                    // æ˜¯å“¡å·¥ï¼šéš±è—æ•æ„ŸåŠŸèƒ½
                    document.getElementById('userRoleBadge').innerText = "ä¸€èˆ¬å“¡å·¥";
                    menuPanel.classList.add('hidden');   // éš±è—æ–°å¢èœå–®
                    menuLock.classList.remove('hidden'); // é¡¯ç¤ºè­¦å‘Š
                    adminTab.classList.add('hidden');    // éš±è—å“¡å·¥ç®¡ç†
                }

                startListeningData(user.email === ADMIN_EMAIL); // é–‹å§‹ç›£è½è³‡æ–™
            } else {
                // --- æœªç™»å…¥ ---
                loginDiv.classList.remove('hidden');
                dashboardDiv.classList.add('hidden');
            }
        });

        // 3. ç™»å…¥æŒ‰éˆ•åŠŸèƒ½
        document.getElementById('btnLogin').addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const pwd = document.getElementById('loginPwd').value;
            signInWithEmailAndPassword(auth, email, pwd)
                .catch((error) => {
                    document.getElementById('loginError').innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
                });
        });

        // 4. ç™»å‡ºæŒ‰éˆ•åŠŸèƒ½
        document.getElementById('btnLogout').addEventListener('click', () => {
            signOut(auth);
            location.reload();
        });

        // 5. ã€è€é—†åŠŸèƒ½ã€‘å»ºç«‹æ–°å“¡å·¥å¸³è™Ÿ (ä½¿ç”¨ Secondary App æŠ€å·§)
        document.getElementById('btnCreateUser').addEventListener('click', async () => {
            const newEmail = document.getElementById('newStaffEmail').value;
            const newPwd = document.getElementById('newStaffPwd').value;
            if (newPwd.length < 6) { alert("å¯†ç¢¼è‡³å°‘è¦6ä½æ•¸"); return; }

            try {
                // æŠ€å·§ï¼šå»ºç«‹ç¬¬äºŒå€‹ App å¯¦ä¾‹ï¼Œé€™æ¨£æ‰ä¸æœƒæŠŠè€é—†è‡ªå·±ç™»å‡º
                const secondaryApp = initializeApp(firebaseConfig, "Secondary");
                const secondaryAuth = getAuth(secondaryApp);
                
                await createUserWithEmailAndPassword(secondaryAuth, newEmail, newPwd);
                
                alert(`âœ… å“¡å·¥å¸³è™Ÿ ${newEmail} å»ºç«‹æˆåŠŸï¼\nè«‹å°‡å¸³å¯†äº¤çµ¦å“¡å·¥ã€‚`);
                document.getElementById('newStaffEmail').value = "";
                document.getElementById('newStaffPwd').value = "";
                
                // éŠ·æ¯€è‡¨æ™‚å¯¦ä¾‹
                // deleteApp(secondaryApp); // ç°¡å–®ç‰ˆå¯çœç•¥
            } catch (error) {
                console.error(error);
                alert("âŒ å»ºç«‹å¤±æ•—ï¼š" + error.message);
            }
        });


        // 6. è³‡æ–™ç›£è½ (åŒ…æˆå‡½å¼ï¼Œç™»å…¥å¾Œæ‰åŸ·è¡Œ)
        function startListeningData(isAdmin) {
            
            // A. è¨‚å–®ç›£è½ (è€é—†å“¡å·¥éƒ½çœ‹å¾—åˆ°)
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('orderList');
                container.innerHTML = "";
                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-muted">ç›®å‰æ²’æœ‰è¨‚å–®</p>'; return; }

                snapshot.forEach(docSnapshot => {
                    const order = docSnapshot.data();
                    let itemsHtml = "";
                    for (let key in order.items) itemsHtml += `<div>â€¢ ${order.items[key].name} x ${order.items[key].qty}</div>`;
                    
                    container.innerHTML += `
                    <div class="card p-3 shadow-sm order-card">
                        <div class="d-flex justify-content-between">
                            <h5>æ¡Œè™Ÿ: ${order.table}</h5>
                            <button class="btn btn-success btn-sm" onclick="window.finishOrder('${docSnapshot.id}')">å®Œæˆ</button>
                        </div>
                        <hr class="my-2">${itemsHtml}
                        <div class="text-end fw-bold mt-2">ç¸½è¨ˆ: $${order.total}</div>
                    </div>`;
                });
            });

            // B. èœå–®ç›£è½ (å¦‚æœæ˜¯å“¡å·¥ï¼Œåªèƒ½çœ‹ä¸èƒ½åˆª)
            onSnapshot(collection(db, "menu"), (snapshot) => {
                const list = document.getElementById('menuList');
                list.innerHTML = "";
                snapshot.forEach(d => {
                    const data = d.data();
                    let deleteBtn = "";
                    // åªæœ‰è€é—†æ‰æœ‰åˆªé™¤æŒ‰éˆ•
                    if (isAdmin) {
                        deleteBtn = `<button class="btn btn-sm btn-danger del-btn" data-id="${d.id}">åˆªé™¤</button>`;
                    }
                    
                    const li = document.createElement('li');
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `${data.name} ($${data.price}) ${deleteBtn}`;
                    list.appendChild(li);
                });

                if (isAdmin) {
                    document.querySelectorAll('.del-btn').forEach(btn => {
                        btn.onclick = () => deleteDoc(doc(db, "menu", btn.dataset.id));
                    });
                }
            });
        }

        // å®šç¾©å…¨åŸŸåŠŸèƒ½
        window.finishOrder = async function(id) {
            if(confirm("ç¢ºå®šå®Œæˆï¼Ÿ")) await deleteDoc(doc(db, "orders", id));
        }

        // C. æ–°å¢èœå–® (åªæœ‰è€é—†èƒ½è§¸ç™¼)
        document.getElementById('addBtn').addEventListener('click', async () => {
            const name = document.getElementById('name').value;
            const price = Number(document.getElementById('price').value);
            const note = document.getElementById('note').value;
            if(name && price) {
                await addDoc(collection(db, "menu"), { name, price, placeholder: note });
                document.getElementById('name').value=''; document.getElementById('price').value='';
            }
        });

    </script>
</body>
</html>