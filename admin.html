<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ç®¡ç†å¾Œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-card { border-left: 5px solid #0d6efd; background: #fff; margin-bottom: 15px; }
        .order-time { font-size: 0.8rem; color: #888; }
    </style>
</head>
<body class="p-4 bg-light">
    <div class="container">
        
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-orders-tab" data-bs-toggle="pill" data-bs-target="#pills-orders" type="button">ğŸ”” æ¥æ”¶è¨‚å–®</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-menu-tab" data-bs-toggle="pill" data-bs-target="#pills-menu" type="button">ğŸ“ èœå–®ç®¡ç†</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-orders">
                <div id="orderList">
                    <p class="text-center text-muted">ç­‰å¾…æ–°è¨‚å–®ä¸­...</p>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-menu">
                <div class="card p-3 mb-3">
                    <div class="input-group mb-2">
                        <input type="text" id="name" class="form-control" placeholder="èœå">
                        <input type="number" id="price" class="form-control" placeholder="åƒ¹æ ¼">
                    </div>
                    <input type="text" id="note" class="form-control mb-2" placeholder="å‚™è¨»æç¤º">
                    <button id="addBtn" class="btn btn-primary w-100">æ–°å¢èœå–®</button>
                </div>
                <ul id="menuList" class="list-group"></ul>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // å¼•å…¥ query å’Œ orderBy ç”¨ä¾†æ’åºè¨‚å–®
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„é‘°åŒ™ âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
            apiKey: "ä½ çš„API_KEY",
            // ... (è«‹ç…§èˆŠå¡«å¯«)
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- åŠŸèƒ½ A: èœå–®ç®¡ç† (ç¶­æŒåŸæœ¬é‚è¼¯) ---
        // (ç‚ºäº†ç‰ˆé¢æ•´æ½”ï¼Œé€™è£¡çœç•¥é‡è¤‡çš„ç¨‹å¼ç¢¼ï¼Œè«‹æŠŠå‰›å‰›é‚£å€‹ã€Œæ–°å¢/åˆªé™¤èœå–®ã€çš„é‚è¼¯ä¿ç•™è‘—)
        // ... (å¦‚æœä½ ç›´æ¥è¤‡è£½æ•´å€‹æª”æ¡ˆï¼Œè«‹ç¢ºä¿ä¸‹é¢æœ‰é€™æ®µé‚è¼¯) ...
        
        document.getElementById('addBtn').addEventListener('click', async () => {
            /* ...åŸæœ¬çš„æ–°å¢é‚è¼¯... */
            const name = document.getElementById('name').value;
            const price = Number(document.getElementById('price').value);
            const note = document.getElementById('note').value;
            if(name && price) {
                await addDoc(collection(db, "menu"), { name, price, placeholder: note });
                document.getElementById('name').value=''; document.getElementById('price').value='';
            }
        });

        onSnapshot(collection(db, "menu"), (snapshot) => {
            const list = document.getElementById('menuList');
            list.innerHTML = "";
            snapshot.forEach(d => {
                const data = d.data();
                const li = document.createElement('li');
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `${data.name} ($${data.price}) <button class="btn btn-sm btn-danger del-btn" data-id="${d.id}">åˆªé™¤</button>`;
                list.appendChild(li);
            });
            // ç¶å®šåˆªé™¤æŒ‰éˆ•
            document.querySelectorAll('.del-btn').forEach(btn => {
                btn.onclick = () => deleteDoc(doc(db, "menu", btn.dataset.id));
            });
        });


        // --- åŠŸèƒ½ B: æ¥æ”¶è¨‚å–® (æ–°åŠŸèƒ½) ---
        
        // ç›£è½ "orders" é›†åˆï¼Œä¸¦ä¾ç…§æ™‚é–“(createdAt) å€’åºæ’åˆ—(desc)
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('orderList');
            container.innerHTML = ""; // æ¸…ç©º

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-muted">ç›®å‰æ²’æœ‰è¨‚å–®</p>';
                return;
            }

            snapshot.forEach(docSnapshot => {
                const order = docSnapshot.data();
                const orderId = docSnapshot.id;
                
                // è½‰æ›æ™‚é–“æ ¼å¼
                let timeString = "å‰›å‰›";
                if (order.createdAt) {
                    const date = order.createdAt.toDate();
                    timeString = date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();
                }

                // ç”¢ç”Ÿè¨‚å–®å¡ç‰‡ HTML
                let itemsHtml = "";
                for (let key in order.items) {
                    const item = order.items[key];
                    itemsHtml += `<div>â€¢ ${item.name} x <b>${item.qty}</b> <span class="text-muted text-sm">${item.note ? '('+item.note+')' : ''}</span></div>`;
                }

                const cardHtml = `
                <div class="card p-3 shadow-sm order-card">
                    <div class="d-flex justify-content-between">
                        <h5>æ¡Œè™Ÿ: ${order.table} <span class="badge bg-warning text-dark">æ–°è¨‚å–®</span></h5>
                        <span class="order-time">${timeString}</span>
                    </div>
                    <hr class="my-2">
                    <div class="mb-2">
                        ${itemsHtml}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="fw-bold text-primary">ç¸½è¨ˆ: $${order.total}</span>
                        <button class="btn btn-success btn-sm" onclick="finishOrder('${orderId}')">å®Œæˆ/çµå¸³</button>
                    </div>
                </div>
                `;
                container.innerHTML += cardHtml;
            });
        });

        // å®Œæˆè¨‚å–® (åˆªé™¤è³‡æ–™)
        window.finishOrder = async function(id) {
            if(confirm("ç¢ºå®šé€™å–®å·²ç¶“å‡ºå®Œ/çµå¸³äº†å—ï¼Ÿ")) {
                await deleteDoc(doc(db, "orders", id));
            }
        }

    </script>
</body>
</html>